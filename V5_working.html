<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voltara Motors: Crossing the Chasm - The Digital Value Engine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #adcdec 0%, #8bc0e3 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Game Selection Screen */
        .game-selection {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .game-selection h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .game-selection h2 {
            color: #7f8c8d;
            margin-bottom: 20px;
            font-weight: 300;
        }
        
        .scenario-intro {
            background: #ecf0f1;
            padding: 25px;
            border-radius: 15px;
            margin: 25px 0;
            text-align: left;
            border-left: 5px solid #3498db;
        }
        
        .scenario-intro h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .start-game-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2rem;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s ease;
        }
        
        .start-game-btn:hover {
            background: #229954;
        }
        
        /* Game Interface */
        .game-interface {
            display: none;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .game-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .year-info {
            font-size: 1.2rem;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }
        
        .budget-info {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .game-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            min-height: 80vh;
        }
        
        .main-panel {
            padding: 30px;
            overflow-y: auto;
        }
        
        .sidebar {
            background: #f8f9fa;
            padding: 20px;
            border-left: 1px solid #dee2e6;
            overflow-y: auto;
        }
        
        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #ecf0f1;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            background: none;
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        .tab-btn.active {
            color: #2c3e50;
            border-bottom-color: #3498db;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* KPI Dashboard */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .kpi-card {
            background: #fff;
            border: 2px solid #ecf0f1;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .kpi-card:hover {
            border-color: #3498db;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .kpi-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .kpi-value.positive { color: #27ae60; }
        .kpi-value.negative { color: #e74c3c; }
        .kpi-value.neutral { color: #3498db; }
        .kpi-value.warning { color: #f39c12; }
        
        .kpi-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        
        .kpi-target {
            font-size: 0.8rem;
            color: #95a5a6;
            border-top: 1px solid #ecf0f1;
            padding-top: 8px;
            margin-top: 8px;
        }
        
        /* Investment Sections */
        .investment-section {
            background: #fff;
            border: 2px solid #ecf0f1;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 15px;
        }
        
        .section-icon {
            font-size: 2rem;
            margin-right: 15px;
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .investment-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .investment-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .investment-card:hover {
            border-color: #3498db;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .investment-card.selected {
            border-color: #27ae60;
            background: #f0f8f0;
        }
        
        .investment-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
        }
        
        .investment-card.previous-selection {
            border-color: #3498db;
            background: #e8f4f8;
        }
        
        .investment-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .investment-description {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .investment-cost {
            color: #e74c3c;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        /* Budget Slider */
        .budget-slider {
            margin: 15px 0;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
        }
        
        .slider {
            flex-grow: 1;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }
        
        .slider-value {
            min-width: 80px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .previous-investment-label {
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            position: absolute;
            top: 10px;
            right: 10px;
        }
        
        /* Action Buttons */
        .action-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin: 5px;
            font-weight: 500;
        }
        
        .action-btn:hover:not(:disabled) {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .action-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .action-btn.success {
            background: #27ae60;
        }
        
        .action-btn.danger {
            background: #e74c3c;
        }
        
        .action-btn.warning {
            background: #f39c12;
        }
        
        /* Course Correction */
        .course-correction {
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #f39c12;
        }
        
        .correction-warning {
            background: #ffeaa7;
            color: #2d3436;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        /* Execute Button in Sidebar */
        .execute-section {
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            border: 2px solid #27ae60;
        }
        
        /* Market Events */
        .market-events {
            background: #fff;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .market-events-header {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            text-align: center;
        }
        
        .market-event {
            padding: 15px 20px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .market-event:last-child {
            border-bottom: none;
        }
        
        .event-impact {
            color: #e74c3c;
            font-weight: bold;
            margin-top: 5px;
        }
        
        /* Investment Summary */
        .investment-summary {
            background: #fff;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .summary-item:last-child {
            border-bottom: none;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .carryover-budget {
            background: #e8f5e8;
            color: #2d5a2d;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        /* Messages */
        .message {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        
        .message.success {
            background: #d5f4e6;
            color: #1e8449;
            border: 1px solid #a3e4d7;
        }
        
        .message.error {
            background: #fadbd8;
            color: #943126;
            border: 1px solid #f1948a;
        }
        
        .message.warning {
            background: #fdeaa7;
            color: #7d6608;
            border: 1px solid #f7dc6f;
        }
        
        .message.info {
            background: #d6eaf8;
            color: #1b4f72;
            border: 1px solid #aed6f1;
        }
        
        /* Logo positioning and styling */
        .logo-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
        }

        .game-started .logo-container {
            position: static;
            padding: 0;
        }

        .dit-logo, .company-logo {
            height: auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .dit-logo {
            width: 120px;
        }

        .company-logo {
            width: 150px;
        }

        .game-started .dit-logo {
            width: 60px;
            padding: 4px;
        }

        .game-started .company-logo {
            width: 75px;
            padding: 4px;
        }

        .main-logo {
            width: 40px;
            height: 40px;
            vertical-align: middle;
            margin-right: 10px;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }

        /* Game content margins */
        .game-selection, .game-interface {
            margin-top: 120px; /* Space for logos */
        }

        .game-started .game-selection {
            display: none;
        }

        .game-started .game-interface {
            margin-top: 0;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .game-selection,
            .game-interface {
                margin-top: 100px;
            }
        }

        @media (max-width: 768px) {
            .dit-logo {
                width: 80px;
            }
            
            .company-logo {
                width: 100px;
            }

            .game-started .dit-logo {
                width: 50px;
            }

            .game-started .company-logo {
                width: 60px;
            }
            
            .main-logo {
                width: 30px;
                height: 30px;
            }
            
            .game-selection,
            .game-interface {
                margin-top: 80px;
            }
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .game-content {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                border-left: none;
                border-top: 1px solid #dee2e6;
            }
            
            .investment-options {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .game-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .tab-navigation {
                overflow-x: auto;
            }
            
            .logo-container {
                top: 5px;
                left: 5px;
            }
            
            .team-logo {
                width: 60px;
            }
            
            .company-logo {
                width: 80px;
            }
            
            .main-logo {
                width: 30px;
                height: 30px;
            }
            
            .game-header {
                justify-content: space-around;
            }
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
</head>
<body>
    <div class="logo-container">
        <img src="aditya-birla-logo.png" alt="Aditya Birla UltraTech" class="company-logo">
        <img src="dit-logo.png" alt="DIT Digital & IT" class="dit-logo">
    </div>

    <div class="container">
        <!-- Game Selection Screen -->
        <div class="game-selection" id="gameSelection">
            <h1>
                <img src="voltara-logo.png" alt="Voltara Motors" class="main-logo">
                Voltara Motors: KBC
            </h1>
            <h2>The Digital Value Engine</h2>
            
            <div class="scenario-intro">
                <h3>üéØ Your Mission as Chief Digital & Information Officer (CDIO)</h3>
                <p style="margin-bottom: 25px;"><strong>The Situation:</strong> Voltara Motors has a brilliant EV product (the Ion-X) but is bleeding cash. You've been brought in as the new CDIO with a clear mandate: transform the Digital & IT organization from a cost center into a value-creation engine.</p>
                
                <p style="margin-bottom: 25px;"><strong>The Challenge:</strong> Every rupee from your ‚Çπ100Cr annual Digital/IT budget must deliver measurable ROI. You have 4 annual decision points over 4 years to help "cross the chasm" while maintaining profitability and achieving sustainable growth.</p>
                
                <p style="margin-bottom: 25px;"><strong>Success Criteria:</strong> End of Year 4 - Market Share >30% to 'Cross the chasm'. Your scores and final ranking will be proportionally based on: Profitability > 5% (min), ROIC > 10% (min)</p>
            </div>
            
            <button class="start-game-btn" id="startGameBtn">
                Begin Digital Transformation Journey
            </button>
            <p style="margin-top: 15px; font-weight: bold; color: #c0392b;" id="waitMessage">Please wait for the administrator to start the game.</p>
            
            <div style="margin-top: 30px; font-size: 0.9rem; color: #7f8c8d;">
                <strong>Game Format:</strong> 4 Years ‚Ä¢ ‚Çπ100Cr Annual Budget ‚Ä¢ Focus on ROI & Value Creation<br>
                <strong>Learning Focus:</strong> Cost Optimization ‚Ä¢ Business Case Analysis ‚Ä¢ Build vs Buy vs Partner
            </div>
        </div>
        
        <!-- Game Interface -->
        <div class="game-interface" id="gameInterface">
            <div class="game-header">
                <div class="team-info">
                    <span style="font-size: 1.5rem; font-weight: bold;">Voltara Motors CDIO Dashboard</span>
                </div>
                <div class="year-info">
                    üìÖ <span id="currentYearDisplay">Year 1</span>/4
                </div>
                <div class="budget-info">
                    <span id="totalBudgetDisplay">üí∞ Available Budget: ‚Çπ100Cr</span>
                    <span id="remainingBudgetDisplay" style="margin-left: 20px;"></span>
                </div>
                <div id="gameTimerDisplay" style="font-size: 1.5rem; font-weight: bold; background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 25px;">20:00</div>
            </div>
            
            <div class="game-content">
                <div class="main-panel">
                    <!-- Tab Navigation -->
                    <div class="tab-navigation">
                        <button class="tab-btn active" onclick="showTab('dashboard')">üìä KPI Dashboard</button>
                        <button class="tab-btn" onclick="showTab('platform')">üèóÔ∏è Platform & Manufacturing</button>
                        <button class="tab-btn" onclick="showTab('customer')">üë• Customer Experience</button>
                        <button class="tab-btn" onclick="showTab('enterprise')">üíº Enterprise Applications</button>
                        <button class="tab-btn" onclick="showTab('analytics')">üìà Analytics & Intelligence</button>
                        <button class="tab-btn" onclick="showTab('marketing')">üì¢ Marketing & Brand</button>
                        <button class="tab-btn" onclick="showTab('security')">üîí Security</button>
                    </div>
                    
                    <!-- KPI Dashboard -->
                    <div class="tab-content active" id="dashboard">
                        <h2>Performance Dashboard</h2>
                        <p style="color: #7f8c8d; margin-bottom: 25px;">
                            Monitor key financial and operational metrics. Your goal: maximize ROI while crossing the chasm.
                        </p>
                        
                        <div class="kpi-grid">
                            <div class="kpi-card">
                                <div class="kpi-value neutral" id="revenue">‚Çπ1200Cr</div>
                                <div class="kpi-label">Annual Revenue</div>
                                <div class="kpi-target">No target but aim for Revenue > ‚Çπ2000Cr by Year 4</div>
                            </div>
                            
                            <div class="kpi-card">
                                <div class="kpi-value warning" id="marketShare">5.2%</div>
                                <div class="kpi-label">Market Share</div>
                                <div class="kpi-target">Target: >30% by Year 4</div>
                            </div>
                            
                            <div class="kpi-card">
                                <div class="kpi-value negative" id="profitability">-5%</div>
                                <div class="kpi-label">Profitability</div>
                                <div class="kpi-target">Target: >5% by Year 4</div>
                            </div>
                            
                            <div class="kpi-card">
                                <div class="kpi-value positive" id="satisfaction">75%</div>
                                <div class="kpi-label">Customer Satisfaction</div>
                                <div class="kpi-target">No target but aim for CSAT >90% by Year 4</div>
                            </div>
                            
                            <div class="kpi-card">
                                <div class="kpi-value negative" id="roic">-18%</div>
                                <div class="kpi-label">ROIC</div>
                                <div class="kpi-target">Target: >10% by Year 4</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Platform & Manufacturing Tab -->
                    <div class="tab-content" id="platform">
                        <h2>üèóÔ∏è Platform & Manufacturing IT</h2>
                        <p style="color: #7f8c8d; margin-bottom: 25px;">
                            Choose your smart factory strategy. Each decision impacts scalability, costs, and efficiency.
                        </p>
                        
                        <div class="investment-section">
                            <div class="section-header">
                                <div class="section-icon">üè≠</div>
                                <div class="section-title">Smart Factory Strategy</div>
                            </div>
                            
                            <div class="investment-options">
                                <div class="investment-card" data-category="platform" data-option="industry40" onclick="selectInvestment('platform', 'industry40', 35)">
                                    <div class="investment-title">üöÄ Industry 4.0 Smart Factory</div>
                                    <div class="investment-description">
                                        Full digital transformation: IoT sensors, AI-driven production, predictive maintenance
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ35Cr</div>
                                    <div class="budget-slider" id="platform-industry40-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="17" max="35" value="35" id="platform-industry40-range">
                                            <span class="slider-value" id="platform-industry40-value">‚Çπ35Cr</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="investment-card" data-category="platform" data-option="incremental" onclick="selectInvestment('platform', 'incremental', 20)">
                                    <div class="investment-title">‚ö° Incremental Automation</div>
                                    <div class="investment-description">
                                        Selective automation: Key production lines, basic digitization
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ20Cr</div>
                                    <div class="budget-slider" id="platform-incremental-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="10" max="20" value="20" id="platform-incremental-range">
                                            <span class="slider-value" id="platform-incremental-value">‚Çπ20Cr</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="investment-card" data-category="platform" data-option="legacy" onclick="selectInvestment('platform', 'legacy', 8)">
                                    <div class="investment-title">üîß Status Quo Legacy</div>
                                    <div class="investment-description">
                                        Minimal upgrades: Basic maintenance, traditional manufacturing
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ8Cr</div>
                                    <div class="budget-slider" id="platform-legacy-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="4" max="8" value="8" id="platform-legacy-range">
                                            <span class="slider-value" id="platform-legacy-value">‚Çπ8Cr</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Customer Experience Tab -->
                    <div class="tab-content" id="customer">
                        <h2>üë• Customer Experience & Sales Tech</h2>
                        <p style="color: #7f8c8d; margin-bottom: 25px;">
                            Design your customer journey and service network strategy.
                        </p>
                        
                        <div class="investment-section">
                            <div class="section-header">
                                <div class="section-icon">üõí</div>
                                <div class="section-title">Customer Journey</div>
                            </div>
                            
                            <div class="investment-options">
                                <div class="investment-card" data-category="customer_journey" data-option="omnichannel" onclick="selectInvestment('customer_journey', 'omnichannel', 25)">
                                    <div class="investment-title">üåê Omnichannel Experience</div>
                                    <div class="investment-description">
                                        Unified online-offline experience, mobile app, VR showrooms
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ25Cr</div>
                                    <div class="budget-slider" id="customer_journey-omnichannel-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="12" max="25" value="25" id="customer_journey-omnichannel-range">
                                            <span class="slider-value" id="customer_journey-omnichannel-value">‚Çπ25Cr</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="investment-card" data-category="customer_journey" data-option="channel_specific" onclick="selectInvestment('customer_journey', 'channel_specific', 15)">
                                    <div class="investment-title">üìä Channel-Specific</div>
                                    <div class="investment-description">
                                        Separate digital and dealer experiences
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ15Cr</div>
                                    <div class="budget-slider" id="customer_journey-channel_specific-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="7" max="15" value="15" id="customer_journey-channel_specific-range">
                                            <span class="slider-value" id="customer_journey-channel_specific-value">‚Çπ15Cr</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="investment-card" data-category="customer_journey" data-option="basic_digital" onclick="selectInvestment('customer_journey', 'basic_digital', 4)">
                                    <div class="investment-title">üíª Basic Digitization</div>
                                    <div class="investment-description">
                                        Simple website and basic dealer tools
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ4Cr</div>
                                    <div class="budget-slider" id="customer_journey-basic_digital-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="2" max="4" value="4" id="customer_journey-basic_digital-range">
                                            <span class="slider-value" id="customer_journey-basic_digital-value">‚Çπ4Cr</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="investment-section">
                            <div class="section-header">
                                <div class="section-icon">üîß</div>
                                <div class="section-title">Service Network</div>
                            </div>
                            
                            <div class="investment-options">
                                <div class="investment-card" data-category="service_network" data-option="predictive" onclick="selectInvestment('service_network', 'predictive', 20)">
                                    <div class="investment-title">ü§ñ Predictive Integrated Planning</div>
                                    <div class="investment-description">
                                        AI-driven service prediction, integrated supply chain
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ20Cr</div>
                                    <div class="budget-slider" id="service_network-predictive-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="10" max="20" value="20" id="service_network-predictive-range">
                                            <span class="slider-value" id="service_network-predictive-value">‚Çπ20Cr</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="investment-card" data-category="service_network" data-option="reactive" onclick="selectInvestment('service_network', 'reactive', 12)">
                                    <div class="investment-title">üì± Reactive Digital</div>
                                    <div class="investment-description">
                                        Digital service booking, basic diagnostics
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ12Cr</div>
                                    <div class="budget-slider" id="service_network-reactive-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="6" max="12" value="12" id="service_network-reactive-range">
                                            <span class="slider-value" id="service_network-reactive-value">‚Çπ12Cr</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="investment-card" data-category="service_network" data-option="traditional" onclick="selectInvestment('service_network', 'traditional', 6)">
                                    <div class="investment-title">üìÖ Scheduled Traditional</div>
                                    <div class="investment-description">
                                        Calendar-based service appointments
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ6Cr</div>
                                    <div class="budget-slider" id="service_network-traditional-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="3" max="6" value="6" id="service_network-traditional-range">
                                            <span class="slider-value" id="service_network-traditional-value">‚Çπ6Cr</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enterprise Applications Tab -->
                    <div class="tab-content" id="enterprise">
                        <h2>üíº Enterprise Applications & Data</h2>
                        <p style="color: #7f8c8d; margin-bottom: 25px;">
                            Build your enterprise backbone with ERP and data platform strategies.
                        </p>
                        
                        <div class="investment-section">
                            <div class="section-header">
                                <div class="section-icon">üè¢</div>
                                <div class="section-title">ERP Strategy</div>
                            </div>
                            
                            <div class="investment-options">
                                <div class="investment-card" data-category="erp" data-option="sap_rise" onclick="selectInvestment('erp', 'sap_rise', 22)">
                                    <div class="investment-title">‚òÅÔ∏è SAP RISE (Managed Cloud)</div>
                                    <div class="investment-description">
                                        Cloud-native ERP, automatic updates, AI capabilities
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ22Cr</div>
                                    <div class="budget-slider" id="erp-sap_rise-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="11" max="22" value="22" id="erp-sap_rise-range">
                                            <span class="slider-value" id="erp-sap_rise-value">‚Çπ22Cr</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="investment-card" data-category="erp" data-option="sap_onprem" onclick="selectInvestment('erp', 'sap_onprem', 28)">
                                    <div class="investment-title">üè¢ SAP On-Premise</div>
                                    <div class="investment-description">
                                        Traditional ERP with full control, higher maintenance
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ28Cr</div>
                                    <div class="budget-slider" id="erp-sap_onprem-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="14" max="28" value="28" id="erp-sap_onprem-range">
                                            <span class="slider-value" id="erp-sap_onprem-value">‚Çπ28Cr</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="investment-card" data-category="erp" data-option="legacy_enhance" onclick="selectInvestment('erp', 'legacy_enhance', 10)">
                                    <div class="investment-title">üîÑ Legacy System Enhancement</div>
                                    <div class="investment-description">
                                        Upgrade existing systems, limited new capabilities
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ10Cr</div>
                                    <div class="budget-slider" id="erp-legacy_enhance-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="5" max="10" value="10" id="erp-legacy_enhance-range">
                                            <span class="slider-value" id="erp-legacy_enhance-value">‚Çπ10Cr</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="investment-section">
                            <div class="section-header">
                                <div class="section-icon">üóÑÔ∏è</div>
                                <div class="section-title">Data Platform</div>
                            </div>
                            
                            <div class="investment-options">
                                <div class="investment-card" data-category="data_platform" data-option="lakehouse" onclick="selectInvestment('data_platform', 'lakehouse', 25)">
                                    <div class="investment-title">üèóÔ∏è Enterprise Data Lakehouse</div>
                                    <div class="investment-description">
                                        Unified analytics platform, real-time insights, ML capabilities
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ25Cr</div>
                                    <div class="budget-slider" id="data_platform-lakehouse-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="12" max="25" value="25" id="data_platform-lakehouse-range">
                                            <span class="slider-value" id="data_platform-lakehouse-value">‚Çπ25Cr</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="investment-card" data-category="data_platform" data-option="warehouse" onclick="selectInvestment('data_platform', 'warehouse', 15)">
                                    <div class="investment-title">üìä Traditional Data Warehouse</div>
                                    <div class="investment-description">
                                        Structured reporting, historical analytics
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ15Cr</div>
                                    <div class="budget-slider" id="data_platform-warehouse-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="7" max="15" value="15" id="data_platform-warehouse-range">
                                            <span class="slider-value" id="data_platform-warehouse-value">‚Çπ15Cr</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="investment-card" data-category="data_platform" data-option="basic_reporting" onclick="selectInvestment('data_platform', 'basic_reporting', 2)">
                                    <div class="investment-title">üìà Basic Reporting Systems</div>
                                    <div class="investment-description">
                                        Simple dashboards, manual reporting
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ2Cr</div>
                                    <div class="budget-slider" id="data_platform-basic_reporting-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="1" max="2" value="2" id="data_platform-basic_reporting-range">
                                            <span class="slider-value" id="data_platform-basic_reporting-value">‚Çπ2Cr</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Analytics & Intelligence Tab -->
                    <div class="tab-content" id="analytics">
                        <h2>üìà Analytics & Intelligence</h2>
                        <p style="color: #7f8c8d; margin-bottom: 25px;">
                            Choose your business intelligence approach to drive data-driven decisions.
                        </p>
                        
                        <div class="investment-section">
                            <div class="section-header">
                                <div class="section-icon">üß†</div>
                                <div class="section-title">Business Intelligence</div>
                            </div>
                            
                            <div class="investment-options">
                                <div class="investment-card" data-category="business_intelligence" data-option="generative_bi" onclick="selectInvestment('business_intelligence', 'generative_bi', 20)">
                                    <div class="investment-title">ü§ñ Generative BI</div>
                                    <div class="investment-description">
                                        AI-powered insights, natural language queries, predictive analytics
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ20Cr</div>
                                    <div class="budget-slider" id="business_intelligence-generative_bi-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="10" max="20" value="20" id="business_intelligence-generative_bi-range">
                                            <span class="slider-value" id="business_intelligence-generative_bi-value">‚Çπ20Cr</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="investment-card" data-category="business_intelligence" data-option="standard_bi" onclick="selectInvestment('business_intelligence', 'standard_bi', 12)">
                                    <div class="investment-title">üìä Standard BI</div>
                                    <div class="investment-description">
                                        Traditional dashboards, standard reporting
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ12Cr</div>
                                    <div class="budget-slider" id="business_intelligence-standard_bi-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="6" max="12" value="12" id="business_intelligence-standard_bi-range">
                                            <span class="slider-value" id="business_intelligence-standard_bi-value">‚Çπ12Cr</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="investment-card" data-category="business_intelligence" data-option="manual_reporting" onclick="selectInvestment('business_intelligence', 'manual_reporting', 4)">
                                    <div class="investment-title">üìã Manual Reporting</div>
                                    <div class="investment-description">
                                        Excel-based reporting, basic charts
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ4Cr</div>
                                    <div class="budget-slider" id="business_intelligence-manual_reporting-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="2" max="4" value="4" id="business_intelligence-manual_reporting-range">
                                            <span class="slider-value" id="business_intelligence-manual_reporting-value">‚Çπ4Cr</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Marketing & Brand Tab -->
                    <div class="tab-content" id="marketing">
                        <h2>üì¢ Marketing & Brand</h2>
                        <p style="color: #7f8c8d; margin-bottom: 25px;">
                            Select your marketing technology strategy to optimize customer acquisition.
                        </p>
                        
                        <div class="investment-section">
                            <div class="section-header">
                                <div class="section-icon">üéØ</div>
                                <div class="section-title">Marketing Tech</div>
                            </div>
                            
                            <div class="investment-options">
                                <div class="investment-card" data-category="marketing_tech" data-option="ai_personalization" onclick="selectInvestment('marketing_tech', 'ai_personalization', 22)">
                                    <div class="investment-title">üöÄ AI Personalization</div>
                                    <div class="investment-description">
                                        Dynamic pricing, personalized recommendations, behavioral targeting
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ22Cr</div>
                                    <div class="budget-slider" id="marketing_tech-ai_personalization-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="11" max="22" value="22" id="marketing_tech-ai_personalization-range">
                                            <span class="slider-value" id="marketing_tech-ai_personalization-value">‚Çπ22Cr</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="investment-card" data-category="marketing_tech" data-option="traditional_digital" onclick="selectInvestment('marketing_tech', 'traditional_digital', 14)">
                                    <div class="investment-title">üì± Traditional Digital</div>
                                    <div class="investment-description">
                                        Standard digital marketing, social media, SEO
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ14Cr</div>
                                    <div class="budget-slider" id="marketing_tech-traditional_digital-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="7" max="14" value="14" id="marketing_tech-traditional_digital-range">
                                            <span class="slider-value" id="marketing_tech-traditional_digital-value">‚Çπ14Cr</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="investment-card" data-category="marketing_tech" data-option="word_of_mouth" onclick="selectInvestment('marketing_tech', 'word_of_mouth', 2)">
                                    <div class="investment-title">üó£Ô∏è Word-of-Mouth/Influence-led</div>
                                    <div class="investment-description">
                                        Referral programs, influencer partnerships, community building
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ2Cr</div>
                                    <div class="budget-slider" id="marketing_tech-word_of_mouth-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="1" max="2" value="2" id="marketing_tech-word_of_mouth-range">
                                            <span class="slider-value" id="marketing_tech-word_of_mouth-value">‚Çπ2Cr</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Security Tab -->
                    <div class="tab-content" id="security">
                        <h2>üîí Security</h2>
                        <p style="color: #7f8c8d; margin-bottom: 25px;">
                            Protect your digital infrastructure with the right security architecture.
                        </p>
                        
                        <div class="investment-section">
                            <div class="section-header">
                                <div class="section-icon">üõ°Ô∏è</div>
                                <div class="section-title">Security Architecture</div>
                            </div>
                            
                            <div class="investment-options">
                                <div class="investment-card" data-category="security" data-option="zero_trust" onclick="selectInvestment('security', 'zero_trust', 16)">
                                    <div class="investment-title">üîê Zero-trust Architecture</div>
                                    <div class="investment-description">
                                        Modern security model, identity-based access, micro-segmentation
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ16Cr</div>
                                    <div class="budget-slider" id="security-zero_trust-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="8" max="16" value="16" id="security-zero_trust-range">
                                            <span class="slider-value" id="security-zero_trust-value">‚Çπ16Cr</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="investment-card" data-category="security" data-option="hybrid" onclick="selectInvestment('security', 'hybrid', 13)">
                                    <div class="investment-title">üîÄ Hybrid Approach</div>
                                    <div class="investment-description">
                                        Mix of modern and traditional security
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ13Cr</div>
                                    <div class="budget-slider" id="security-hybrid-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="6" max="13" value="13" id="security-hybrid-range">
                                            <span class="slider-value" id="security-hybrid-value">‚Çπ13Cr</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="investment-card" data-category="security" data-option="perimeter" onclick="selectInvestment('security', 'perimeter', 10)">
                                    <div class="investment-title">üß± Perimeter Security</div>
                                    <div class="investment-description">
                                        Traditional firewall-based security
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ10Cr</div>
                                    <div class="budget-slider" id="security-perimeter-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="5" max="10" value="10" id="security-perimeter-range">
                                            <span class="slider-value" id="security-perimeter-value">‚Çπ10Cr</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="investment-card" data-category="security" data-option="basic" onclick="selectInvestment('security', 'basic', 4)">
                                    <div class="investment-title">üîí Basic Protection</div>
                                    <div class="investment-description">
                                        Standard antivirus and basic firewalls
                                    </div>
                                    <div class="investment-cost">Cost: ‚Çπ4Cr</div>
                                    <div class="budget-slider" id="security-basic-slider" style="display: none;">
                                        <div class="slider-container">
                                            <input type="range" class="slider" min="2" max="4" value="4" id="security-basic-range">
                                            <span class="slider-value" id="security-basic-value">‚Çπ4Cr</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sidebar -->
                <div class="sidebar">
                    <!-- Execute Section -->
                    <div class="execute-section">
                        <h4 style="margin-bottom: 15px;">üöÄ Execute Plan</h4>
                        <button class="action-btn success" onclick="executeYearPlan()" id="executeButton">
                            ‚úÖ Execute Year <span id="executeYearText">1</span> Plan
                        </button>
                    </div>
                    
                    <!-- Market Events -->
                    <div class="market-events">
                        <div class="market-events-header">
                            üì∞ Market Events - <span id="marketEventYear">Year 1</span>
                        </div>
                        <div id="marketEventsContent">
                            <!-- Market events will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Investment Summary -->
                    <div class="investment-summary">
                        <h4 style="margin-bottom: 15px;">üíº Your Investment Portfolio</h4>
                        <div id="carryoverBudgetDisplay" style="display: none;"></div>
                        <div id="investmentSummary">
                            <div style="color: #7f8c8d; font-style: italic; font-size: 0.9rem;">
                                No investments selected yet. Choose your technology strategy in each category.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Course Correction (Year 2+) -->
                    <div class="course-correction" id="courseCorrectionSection" style="display: none;">
                        <h4 style="margin-bottom: 15px;">üîÑ Course Correction</h4>
                        <button class="action-btn warning" id="courseCorrectionBtn" onclick="enableCourseCorrection()">
                            üìù Modify Previous Decisions
                        </button>
                        <div class="correction-warning">
                            ‚ö†Ô∏è Warning: Course corrections will apply a 10% penalty to your accumulated points and may delay implementation benefits.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyClRZQb35VM5bkpocgRk7pflzGkTtb0Dqw",
            authDomain: "kbc-game-5b830.firebaseapp.com",
            databaseURL: "https://kbc-game-5b830-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "kbc-game-5b830",
            storageBucket: "kbc-game-5b830.appspot.com",
            messagingSenderId: "702022403294",
            appId: "1:702022403294:web:41209d62429543fed5ee4f"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const gameStateRef = database.ref('gameState');
        let teamId = null;
        let teamScoreRef = null;
        let gameTimerInterval;

        // Game State Management
        let gameState = {
            currentYear: 1,
            decisions: {},
            totalBudget: 100,
            carryoverBudget: 0,
            usedBudget: 0,
            kpis: {
                revenue: 1200,
                marketShare: 5.2,
                profitability: -5,
                satisfaction: 75,
                roic: -18
            },
            courseCorrectionEnabled: false,
            previousDecisions: {},
            yearlyBudgetHistory: [],
            gameCompleted: false  
        };

        // Market Events Data
        const marketEvents = {
            1: [
                {
                    title: "Government announces ‚Çπ2L EV subsidy extension",
                    impact: "All EV manufacturers benefit. Advanced manufacturing required to qualify for full benefits."
                },
                {
                    title: "Major Data Breach at Competitor",
                    impact: "Security investments become a key differentiator. Highly secure architecture gains market appeal."
                },
                {
                    title: "5G Network rollout accelerates in Tier-1 Cities",
                    impact: "Connected vehicle features become feasible. Data platform investments show early returns."
                }
            ],
            2: [
                {
                    title: "Global semiconductor crisis intensifies", 
                    impact: "Supply chain disruptions affect smart factory implementations. Status quo manufacturing shows resilience."
                },
                {
                    title: "ChatGPT pioneered revolution transforms customer service",
                    impact: "AI-powered analytics and personalization gain competitive advantage. Manual processes fall behind."
                },
                {
                    title: "BYD enters Indian Market aggressively",
                    impact: "Price competition intensifies. Cost optimization and efficiency become critical for survival."
                }
            ],
            3: [
                {
                    title: "Autonomous vehicle regulations announced",
                    impact: "Connected vehicle data becomes mandatory. Real-time analytics and security compliance required."
                },
                {
                    title: "Energy costs surge due to global crisis",
                    impact: "Cloud infrastructure costs increase. On-prem solutions may show cost advantages in some scenarios."
                },
                {
                    title: "Consumer Data Privacy laws tighten",
                    impact: "AI personalization faces restrictions. Traditional marketing approaches regain relevance."
                }
            ],
            4: [
                {
                    title: "EV Market matures - consolidation begins",
                    impact: "Only efficient players survive. Technology differentiation becomes winner-take-all proposition."
                },
                {
                    title: "Quantum Computing breakthrough",
                    impact: "Existing security becomes obsolete. All players face mandatory quantum-safe upgrades."
                },
                {
                    title: "Global recession + Supply Chain nationalism",
                    impact: "Local sourcing mandated. Previous technology choices determine survival capability."
                }
            ]
        };

        // Decision Options Data
        const decisionOptions = {
            platform: { min: 1, options: ['industry40', 'incremental', 'legacy'] },
            customer_journey: { min: 1, options: ['omnichannel', 'channel_specific', 'basic_digital'] },
            service_network: { min: 1, options: ['predictive', 'reactive', 'traditional'] },
            erp: { min: 1, options: ['sap_rise', 'sap_onprem', 'legacy_enhance'] },
            data_platform: { min: 1, options: ['lakehouse', 'warehouse', 'basic_reporting'] },
            business_intelligence: { min: 1, options: ['generative_bi', 'standard_bi', 'manual_reporting'] },
            marketing_tech: { min: 1, options: ['ai_personalization', 'traditional_digital', 'word_of_mouth'] },
            security: { min: 1, options: ['zero_trust', 'hybrid', 'perimeter', 'basic'] }
        };

        // Base costs for each option (UPDATED PRICES)
        const baseCosts = {
            platform: { industry40: 35, incremental: 20, legacy: 8 },
            customer_journey: { omnichannel: 25, channel_specific: 15, basic_digital: 4 },
            service_network: { predictive: 20, reactive: 12, traditional: 6 },
            erp: { sap_rise: 22, sap_onprem: 28, legacy_enhance: 10 },
            data_platform: { lakehouse: 25, warehouse: 15, basic_reporting: 2 },
            business_intelligence: { generative_bi: 20, standard_bi: 12, manual_reporting: 4 },
            marketing_tech: { ai_personalization: 22, traditional_digital: 14, word_of_mouth: 2 },
            security: { zero_trust: 16, hybrid: 13, perimeter: 10, basic: 4 }
        };

        // COMPLETE DECISION IMPACTS (ALL OPTIONS COVERED)
        const decisionImpacts = {
            platform: {
                industry40: { base_ms: 0.45, base_rev: 1.8, base_prof: 1.35, base_roic: 2.25, base_csat: 0.9, formula: { ms: 50, rev: 40 } },
                incremental: { base_ms: 0.18, base_rev: 0.9, base_prof: 0.45, base_roic: 0.9, base_csat: 0.45, formula: { ms: 50, rev: 40 } },
                legacy: { base_ms: 0, base_rev: 0, base_prof: -1, base_roic: -1, base_csat: 0, formula: { ms: 50, rev: 40 } }
            },
            customer_journey: {
                omnichannel: { base_ms: 0.54, base_rev: 2.7, base_prof: 0.45, base_roic: 0.9, base_csat: 2.7, formula: { ms: 50, rev: 40 } },
                channel_specific: { base_ms: 0.18, base_rev: 0.9, base_prof: 0, base_roic: 0.45, base_csat: 0.9, formula: { ms: 50, rev: 40 } },
                basic_digital: { base_ms: 0.09, base_rev: 0.45, base_prof: 0, base_roic: 0, base_csat: 0.45, formula: { ms: 50, rev: 40 } }
            },
            service_network: {
                predictive: { base_ms: 0.27, base_rev: 1.35, base_prof: 0.9, base_roic: 1.35, base_csat: 1.8, formula: { ms: 50, rev: 40 } },
                reactive: { base_ms: 0.09, base_rev: 0.45, base_prof: 0.45, base_roic: 0.45, base_csat: 0.9, formula: { ms: 50, rev: 40 } },
                traditional: { base_ms: 0, base_rev: 0, base_prof: 0, base_roic: 0, base_csat: 0, formula: { ms: 50, rev: 40 } }
            },
            erp: {
                sap_rise: { base_ms: 0.18, base_rev: 0.9, base_prof: 1.8, base_roic: 1.8, base_csat: 0, formula: { ms: 50, rev: 40 } },
                sap_onprem: { base_ms: 0.09, base_rev: 0.45, base_prof: 0.9, base_roic: 0.9, base_csat: 0, formula: { ms: 50, rev: 40 } },
                legacy_enhance: { base_ms: 0, base_rev: 0, base_prof: 0.45, base_roic: 0.45, base_csat: 0, formula: { ms: 50, rev: 40 } }
            },
            data_platform: {
                lakehouse: { base_ms: 0.36, base_rev: 1.35, base_prof: 0.9, base_roic: 1.35, base_csat: 0.9, formula: { ms: 50, rev: 40 } },
                warehouse: { base_ms: 0.18, base_rev: 0.72, base_prof: 0.45, base_roic: 0.72, base_csat: 0.45, formula: { ms: 50, rev: 40 } },
                basic_reporting: { base_ms: 0.09, base_rev: 0.18, base_prof: 0, base_roic: 0.18, base_csat: 0, formula: { ms: 50, rev: 40 } }
            },
            business_intelligence: {
                generative_bi: { base_ms: 0.45, base_rev: 2.25, base_prof: 0.45, base_roic: 0.9, base_csat: 2.25, formula: { ms: 50, rev: 40 } },
                standard_bi: { base_ms: 0.18, base_rev: 0.9, base_prof: 0.27, base_roic: 0.45, base_csat: 0.9, formula: { ms: 50, rev: 40 } },
                manual_reporting: { base_ms: 0, base_rev: 0, base_prof: 0, base_roic: 0, base_csat: 0, formula: { ms: 50, rev: 40 } }
            },
            marketing_tech: {
                ai_personalization: { base_ms: 0.72, base_rev: 3.6, base_prof: 0.9, base_roic: 1.35, base_csat: 2.25, formula: { ms: 50, rev: 40 } },
                traditional_digital: { base_ms: 0.36, base_rev: 1.8, base_prof: 0, base_roic: 0, base_csat: 0.9, formula: { ms: 50, rev: 40 } },
                word_of_mouth: { base_ms: 0.18, base_rev: 0.9, base_prof: 0.45, base_roic: 0.9, base_csat: 1.35, formula: { ms: 50, rev: 40 } }
            },
            security: {
                zero_trust: { base_ms: 0.27, base_rev: 0.45, base_prof: 0.9, base_roic: 1.35, base_csat: 1.35, formula: { ms: 50, rev: 40 } },
                hybrid: { base_ms: 0.09, base_rev: 0, base_prof: 0.45, base_roic: 0.45, base_csat: 0.45, formula: { ms: 50, rev: 40 } },
                perimeter: { base_ms: 0, base_rev: 0, base_prof: 0, base_roic: 0, base_csat: 0, formula: { ms: 50, rev: 40 } },
                basic: { base_ms: 0, base_rev: 0, base_prof: -1.5, base_roic: -2, base_csat: -2, formula: { ms: 0, rev: 0 } }
            }
        };

        // FIXED SYNERGY BONUSES with proper alt_trigger handling
        const synergyBonuses = {
            1: {
                "Government announces ‚Çπ2L EV subsidy extension": { trigger: "industry40", ms: 2.0, rev: 2.4, prof: 1.6, roic: 2.4 },
                "Major Data Breach at Competitor": { trigger: "zero_trust", ms: 1.6, rev: 0.8, prof: 0.8, roic: 1.6 },
                "5G Network rollout accelerates in Tier-1 Cities": { trigger: "omnichannel", ms: 1.2, rev: 2.0, prof: 0.4, roic: 0.8 }
            },
            2: {
                "Global semiconductor crisis intensifies": { trigger: "legacy", ms: 0.4, rev: 0.4, prof: 2.0, roic: 1.6 },
                "ChatGPT pioneered revolution transforms customer service": { trigger: "generative_bi", alt_trigger: "ai_personalization", ms: 2.4, rev: 3.2, prof: 0.8, roic: 1.2 },
                "BYD enters Indian Market aggressively": { trigger: "sap_rise", ms: 0.8, rev: 0.8, prof: 2.4, roic: 2.4 }
            },
            3: {
                "Autonomous vehicle regulations announced": { trigger: "lakehouse", ms: 1.6, rev: 1.2, prof: 0.8, roic: 2.0 },
                "Energy costs surge due to global crisis": { trigger: "sap_onprem", ms: 0.4, rev: 0.4, prof: 1.6, roic: 2.0 },
                "Consumer Data Privacy laws tighten": { trigger: "traditional_digital", ms: 1.2, rev: 0.8, prof: 0.4, roic: 0.8 }
            },
            4: {
                "EV Market matures - consolidation begins": { trigger: "ai_personalization", ms: 2.8, rev: 2.4, prof: 1.6, roic: 1.6 },
                "Quantum Computing breakthrough": { trigger: "zero_trust", ms: 2.0, rev: 0.8, prof: 2.4, roic: 2.4 },
                "Global recession + Supply Chain nationalism": { trigger: "legacy_enhance", alt_trigger: "basic_reporting", ms: 0.8, rev: 0.4, prof: 1.6, roic: 1.2 }
            }
        };

        function startGame() {
            console.log("startGame function called");
            document.body.classList.add('game-started');
            
            const logoContainer = document.querySelector('.logo-container');
            const gameHeader = document.querySelector('.game-header');
            gameHeader.prepend(logoContainer);

            document.getElementById('gameSelection').style.display = 'none';
            document.getElementById('gameInterface').style.display = 'block';
            updateDisplay();
            loadMarketEvents();
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function selectInvestment(category, option, baseCost) {
            // If course correction is not enabled and we're in Year 2+, only allow changes to current year decisions
            if (gameState.currentYear > 1 && !gameState.courseCorrectionEnabled) {
                if (gameState.previousDecisions[category] && gameState.previousDecisions[category].option !== option) {
                    showMessage('Course correction required to change previous year decisions', 'warning');
                    return;
                }
            }

            const selectedCard = event.target.closest('.investment-card');
            
            // If the clicked card is already selected, do nothing.
            if (selectedCard.classList.contains('selected') && gameState.decisions[category]?.option === option) {
                return;
            }

            // Deselect other options in this category
            document.querySelectorAll(`[data-category="${category}"]`).forEach(card => {
                card.classList.remove('selected');
            });
            
            // Select this option
            selectedCard.classList.add('selected');
            
            // Show/hide sliders
            hideAllSlidersInCategory(category);
            
            const shouldShowSlider = gameState.currentYear > 1;
            
            if (shouldShowSlider) {
                const slider = document.getElementById(`${category}-${option}-slider`);
                if (slider) {
                    slider.style.display = 'block';
                    setupSliderForOption(category, option, baseCost);
                }
            }
            
            // Store the decision. If it's a new selection in a course-correction year, use baseCost.
            // Otherwise, if it's a re-selection of a previous choice, its cost is already in gameState.decisions
            if (!gameState.decisions[category] || gameState.decisions[category].option !== option) {
                 gameState.decisions[category] = {
                    option: option,
                    cost: baseCost
                };
            }
            
            updateBudgetDisplay();
            updateInvestmentSummary();
        }

        function hideAllSlidersInCategory(category) {
            const options = decisionOptions[category].options;
            options.forEach(option => {
                const slider = document.getElementById(`${category}-${option}-slider`);
                if (slider) {
                    slider.style.display = 'none';
                }
            });
        }

        function setupSliderForOption(category, option, baseCost) {
            const range = document.getElementById(`${category}-${option}-range`);
            const value = document.getElementById(`${category}-${option}-value`);
            
            if (range && value) {
                const remainingBudget = getAvailableBudget() - (gameState.usedBudget - (gameState.decisions[category]?.cost || 0));
                const minCost = Math.ceil(baseCost * 0.5);
                const maxCost = baseCost * 2;
                
                range.min = minCost;
                range.max = maxCost;
                
                if (gameState.decisions[category] && gameState.decisions[category].option === option) {
                    range.value = gameState.decisions[category].cost;
                } else {
                    range.value = baseCost;
                }
                
                value.textContent = `‚Çπ${range.value}Cr`;
                
                // Remove existing event listeners
                range.replaceWith(range.cloneNode(true));
                const newRange = document.getElementById(`${category}-${option}-range`);
                
                // Add new event listener
                newRange.addEventListener('input', function() {
                    const newCost = parseInt(this.value);
                    value.textContent = `‚Çπ${newCost}Cr`;
                    
                    // Update decision cost
                    gameState.decisions[category] = {
                        option: option,
                        cost: newCost
                    };
                    
                    updateBudgetDisplay();
                    updateInvestmentSummary();
                });
            }
        }

        function getAvailableBudget() {
            return gameState.totalBudget + gameState.carryoverBudget;
        }

        function updateBudgetDisplay() {
            gameState.usedBudget = Object.values(gameState.decisions).reduce((sum, decision) => sum + decision.cost, 0);
            
            const availableBudget = getAvailableBudget();
            const remainingBudget = availableBudget - gameState.usedBudget;
            
            const totalBudgetDisplay = document.getElementById('totalBudgetDisplay');
            const remainingBudgetDisplay = document.getElementById('remainingBudgetDisplay');

            if (totalBudgetDisplay) {
                totalBudgetDisplay.innerHTML = `üí∞ Available Budget: ‚Çπ${availableBudget}Cr`;
            }
            
            if(remainingBudgetDisplay) {
                if (remainingBudget < 0) {
                    remainingBudgetDisplay.style.color = '#f1c40f';
                    remainingBudgetDisplay.innerHTML = ` | Budget Exceeded by ‚Çπ${Math.abs(remainingBudget)}Cr!`;
                } else {
                    remainingBudgetDisplay.style.color = 'white';
                    remainingBudgetDisplay.innerHTML = ` | Remaining: ‚Çπ${remainingBudget}Cr`;
                }
            }
        }

        function updateCarryoverBudgetDisplay() {
            const carryoverDisplay = document.getElementById('carryoverBudgetDisplay');
            
            if (gameState.carryoverBudget > 0) {
                carryoverDisplay.style.display = 'block';
                carryoverDisplay.innerHTML = `
                    <div class="carryover-budget">
                        üí∞ Carried forward budget from previous year(s): ‚Çπ${gameState.carryoverBudget}Cr
                    </div>
                `;
            } else {
                carryoverDisplay.style.display = 'none';
            }
        }

        function updateInvestmentSummary() {
            const summaryElement = document.getElementById('investmentSummary');
            
            if (Object.keys(gameState.decisions).length === 0) {
                summaryElement.innerHTML = `
                    <div style="color: #7f8c8d; font-style: italic; font-size: 0.9rem;">
                        No investments selected yet. Choose your technology strategy in each category.
                    </div>
                `;
                return;
            }
            
            let summaryHtml = '';
            let totalCost = 0;
            
            Object.entries(gameState.decisions).forEach(([category, decision]) => {
                totalCost += decision.cost;
                const categoryName = category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                const optionName = decision.option.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                summaryHtml += `
                    <div class="summary-item">
                        <span>${categoryName}</span>
                        <span>‚Çπ${decision.cost}Cr</span>
                    </div>
                    <div style="font-size: 0.8rem; color: #7f8c8d; margin-bottom: 10px; padding-left: 10px;">
                        ${optionName}
                    </div>
                `;
            });
            
            const availableBudget = getAvailableBudget();
            const exceedsBudget = totalCost > availableBudget;
            
            summaryHtml += `
                <div class="summary-item">
                    <span>Total Investment</span>
                    <span style="color: ${exceedsBudget ? '#e74c3c' : '#27ae60'}">‚Çπ${totalCost}Cr</span>
                </div>
                <div class="summary-item">
                    <span>Available Budget</span>
                    <span>‚Çπ${availableBudget}Cr</span>
                </div>
            `;
            
            summaryElement.innerHTML = summaryHtml;
        }

        function loadMarketEvents() {
            const eventsContainer = document.getElementById('marketEventsContent');
            const yearSpan = document.getElementById('marketEventYear');
            
            yearSpan.textContent = `Year ${gameState.currentYear}`;
            
            const events = marketEvents[gameState.currentYear] || [];
            let eventsHtml = '';
            
            if (events.length === 0) {
                eventsHtml = '<div class="market-event">No major market events this year.</div>';
            } else {
                events.forEach(event => {
                    eventsHtml += `
                        <div class="market-event">
                            <strong>${event.title}</strong>
                            <div class="event-impact">${event.impact}</div>
                        </div>
                    `;
                });
            }
            
            eventsContainer.innerHTML = eventsHtml;
        }

        function executeYearPlan() {
                // PREVENT MULTIPLE EXECUTIONS AFTER GAME COMPLETION
            if (gameState.gameCompleted) {
                showMessage('Game already completed! Final results are locked.', 'warning');
                return;
            }
            // Validate that all required categories have selections
            const requiredCategories = Object.keys(decisionOptions);
            const selectedCategories = Object.keys(gameState.decisions);
            
            const missingCategories = requiredCategories.filter(cat => !selectedCategories.includes(cat));
            
            if (missingCategories.length > 0) {
                showMessage(`Please select options for: ${missingCategories.join(', ')}`, 'error');
                return;
            }
            
            // Validate budget
            const availableBudget = getAvailableBudget();
            if (gameState.usedBudget > availableBudget) {
                showMessage(`Budget exceeded by ‚Çπ${gameState.usedBudget - availableBudget}Cr. Please adjust your selections.`, 'error');
                return;
            }
            
            // Apply course correction penalty if enabled
            if (gameState.courseCorrectionEnabled) {
                applyCourseCorrectionPenalty();
                gameState.courseCorrectionEnabled = false;
            }
            
            // Calculate carryover budget for next year (up to 25Cr)
            const unusedBudget = availableBudget - gameState.usedBudget;
            const nextYearCarryover = Math.min(unusedBudget, 25);
            
            // Store budget history
            gameState.yearlyBudgetHistory.push({
                year: gameState.currentYear,
                allocated: gameState.usedBudget,
                carryover: nextYearCarryover
            });
            
            // Calculate KPI impacts (FIXED IMPLEMENTATION)
            updateKPIs();
            
            // Store decisions as previous year decisions
            gameState.previousDecisions = { ...gameState.decisions };
            
            // Advance to next year
            gameState.currentYear++;
            
            // Save the current state to Firebase for persistence
            if (teamId) {
                const teamStateRef = database.ref(`teamStates/team${teamId}`);
                teamStateRef.set(gameState);
            }
            
            if (gameState.currentYear <= 4) {
                // Set carryover budget for next year
                gameState.carryoverBudget = nextYearCarryover;
                
                // Reset for next year
                resetForNextYear();
                showMessage(`Year ${gameState.currentYear - 1} plan executed successfully! Welcome to Year ${gameState.currentYear}. Carryover budget: ‚Çπ${nextYearCarryover}Cr`, 'success');
            } else {
            // Game completed - LOCK THE GAME
            gameState.gameCompleted = true;
            
            // Disable the execute button permanently
            const executeButton = document.getElementById('executeButton');
            if (executeButton) {
                executeButton.disabled = true;
                executeButton.textContent = 'üîí Game Completed';
                executeButton.style.background = '#95a5a6';
                executeButton.style.cursor = 'not-allowed';
            }
            
            showGameResults();
        }
        }

        function resetForNextYear() {
            // Clear current year decisions but keep previous decisions
            gameState.decisions = {};
            gameState.usedBudget = 0;
            
            // Update display
            updateDisplay();
            loadMarketEvents();
            updateCarryoverBudgetDisplay();
            
            // Show course correction section for Year 2+
            if (gameState.currentYear >= 2) {
                document.getElementById('courseCorrectionSection').style.display = 'block';
                setupSlidersForPreviousDecisions();
                
                // Reset course correction for the new year
                gameState.courseCorrectionEnabled = false;
                const courseCorrectionBtn = document.getElementById('courseCorrectionBtn');
                courseCorrectionBtn.textContent = 'üìù Modify Previous Decisions';
                courseCorrectionBtn.disabled = false;
            }
            
            // Reset investment cards
            document.querySelectorAll('.investment-card').forEach(card => {
                card.classList.remove('selected', 'previous-selection');
                const previousLabel = card.querySelector('.previous-investment-label');
                if (previousLabel) {
                    previousLabel.remove();
                }
            });
            
            // Hide all sliders
            document.querySelectorAll('.budget-slider').forEach(slider => {
                slider.style.display = 'none';
            });
            
            updateInvestmentSummary();
        }

        function setupSlidersForPreviousDecisions() {
            // Deep copy previous decisions to the current state for the new year
            gameState.decisions = JSON.parse(JSON.stringify(gameState.previousDecisions));

            Object.entries(gameState.decisions).forEach(([category, decision]) => {
                const card = document.querySelector(`[data-category="${category}"][data-option="${decision.option}"]`);
                if (card) {
                    card.classList.add('selected', 'previous-selection');
                    
                    const label = document.createElement('div');
                    label.className = 'previous-investment-label';
                    label.textContent = `Year ${gameState.currentYear - 1}`;
                    // Avoid adding duplicate labels
                    if (!card.querySelector('.previous-investment-label')) {
                        card.appendChild(label);
                    }
                    
                    const slider = document.getElementById(`${category}-${decision.option}-slider`);
                    if (slider) {
                        slider.style.display = 'block';
                        // Pass the decision object which contains the correct cost from the previous year
                        setupSliderForPreviousDecision(category, decision);
                    }
                }

                if (!gameState.courseCorrectionEnabled) {
                    document.querySelectorAll(`[data-category="${category}"]`).forEach(otherCard => {
                        if (otherCard.dataset.option !== decision.option) {
                            otherCard.classList.add('disabled');
                        }
                    });
                }
            });
            updateBudgetDisplay();
            updateInvestmentSummary();
        }

        function setupSliderForPreviousDecision(category, decision) {
            const range = document.getElementById(`${category}-${decision.option}-range`);
            const value = document.getElementById(`${category}-${decision.option}-value`);
            
            if (range && value) {
                const baseCost = baseCosts[category][decision.option];
                const remainingBudget = getAvailableBudget() - (gameState.usedBudget - decision.cost);
                const minCost = Math.ceil(baseCost * 0.5);
                const maxCost = baseCost * 2;

                range.min = minCost;
                range.max = maxCost;
                range.value = decision.cost;
                value.textContent = `‚Çπ${range.value}Cr`;
                
                // Remove existing event listeners
                range.replaceWith(range.cloneNode(true));
                const newRange = document.getElementById(`${category}-${decision.option}-range`);
                
                // Add new event listener
                newRange.addEventListener('input', function() {
                    const newCost = parseInt(this.value);
                    value.textContent = `‚Çπ${newCost}Cr`;
                    
                    // Update decision cost
                    gameState.decisions[category] = {
                        option: decision.option,
                        cost: newCost
                    };
                    
                    updateBudgetDisplay();
                    updateInvestmentSummary();
                });
            }
        }

        function enableCourseCorrection() {
            gameState.courseCorrectionEnabled = true;
            
            // Enable all investment cards for selection
            document.querySelectorAll('.investment-card').forEach(card => {
                card.classList.remove('disabled');
            });

            // Re-run setup for previous decisions to ensure sliders are visible and correctly configured
            Object.entries(gameState.previousDecisions).forEach(([category, decision]) => {
                const card = document.querySelector(`[data-category='${category}'][data-option='${decision.option}']`);
                if (card) {
                    // Ensure it remains visually selected
                    card.classList.add('selected', 'previous-selection');
                    
                    // Show and re-setup slider
                    const slider = document.getElementById(`${category}-${decision.option}-slider`);
                    if (slider) {
                        slider.style.display = 'block';
                        setupSliderForPreviousDecision(category, decision);
                    }
                }
            });
            
            showMessage('Course correction enabled! You can now change any of your previous investment decisions. Your prior choices are highlighted, but you are free to select new options.', 'warning');
            
            // Update button state
            const courseCorrectionBtn = document.getElementById('courseCorrectionBtn');
            courseCorrectionBtn.textContent = '‚úÖ Course Correction Active';
            courseCorrectionBtn.disabled = true;
        }

        function applyCourseCorrectionPenalty() {
            // Apply 10% penalty to all KPIs (REDUCED FROM 20%)
            Object.keys(gameState.kpis).forEach(kpi => {
                gameState.kpis[kpi] *= 0.9;
            });
            
            showMessage('Course correction penalty applied: -10% to all KPIs', 'warning');
        }

        // FIXED KPI UPDATE FUNCTION with proper error handling and synergy logic
        function updateKPIs() {
            const decisions = gameState.decisions;
            
            // Store total percentage increases
            let marketShareIncrease = 0;
            let revenueIncreasePercent = 0;
            let profitabilityIncrease = 0;
            let roicIncrease = 0;
            let satisfactionIncrease = 0;

            // 1. Base Increases (ŒîBase)
            marketShareIncrease += 1.0;
            revenueIncreasePercent += 5.0;
            profitabilityIncrease += 1.0;
            roicIncrease += 2.0;
            satisfactionIncrease += 2.0;

            // 2. Decision Bonuses (Œ£ ŒîDecisions) with error handling
            Object.entries(decisions).forEach(([category, decision]) => {
                const impact = decisionImpacts[category]?.[decision.option];
                if (!impact) {
                    console.warn(`No impact data found for ${category}.${decision.option}`);
                    return;
                }

                const cost = decision.cost;
                
                // Safe calculation with fallbacks
                marketShareIncrease += (impact.base_ms || 0) + 
                    (impact.formula?.ms ? (cost / impact.formula.ms) : 0);
                revenueIncreasePercent += (impact.base_rev || 0) + 
                    (impact.formula?.rev ? (cost / impact.formula.rev) : 0);
                profitabilityIncrease += (impact.base_prof || 0);
                roicIncrease += (impact.base_roic || 0);
                satisfactionIncrease += (impact.base_csat || 0);
            });

            // 3. FIXED Synergy Bonuses (Œ£ ŒîSynergy)
            const currentYearSynergies = synergyBonuses[gameState.currentYear];
            const activeMarketEvents = marketEvents[gameState.currentYear]?.map(e => e.title) || [];
            const playerOptions = Object.values(decisions).map(d => d.option);

            if (currentYearSynergies) {
                activeMarketEvents.forEach(eventTitle => {
                    const synergy = currentYearSynergies[eventTitle];
                    if (!synergy) return;
                    
                    // FIXED: Check for both primary trigger AND alt_trigger
                    let triggerMatched = false;
                    let matchedTrigger = '';
                    
                    if (synergy.trigger && playerOptions.includes(synergy.trigger)) {
                        triggerMatched = true;
                        matchedTrigger = synergy.trigger;
                    } else if (synergy.alt_trigger && playerOptions.includes(synergy.alt_trigger)) {
                        triggerMatched = true;
                        matchedTrigger = synergy.alt_trigger;
                    }
                    
                    if (triggerMatched) {
                        marketShareIncrease += synergy.ms || 0;
                        revenueIncreasePercent += synergy.rev || 0;
                        profitabilityIncrease += synergy.prof || 0;
                        roicIncrease += synergy.roic || 0;
                        
                        // Show synergy message with correct trigger name
                        showMessage(
                            `üéØ Synergy Bonus! Your choice of '${matchedTrigger}' aligned with '${eventTitle}', yielding extra returns!`, 
                            'info'
                        );
                        
                        console.log(`Synergy triggered: ${eventTitle} -> ${matchedTrigger}`, {
                            ms: synergy.ms,
                            rev: synergy.rev,
                            prof: synergy.prof,
                            roic: synergy.roic
                        });
                    }
                });
            }

            // Apply all increases to the main KPI state
            gameState.kpis.revenue *= (1 + revenueIncreasePercent / 100);
            gameState.kpis.marketShare += marketShareIncrease;
            gameState.kpis.profitability += profitabilityIncrease;
            gameState.kpis.satisfaction += satisfactionIncrease;
            gameState.kpis.roic += roicIncrease;
            
            // Apply caps and floors with better bounds checking
            gameState.kpis.marketShare = Math.min(100, Math.max(0, gameState.kpis.marketShare));
            gameState.kpis.satisfaction = Math.min(100, Math.max(0, gameState.kpis.satisfaction));
            gameState.kpis.profitability = Math.max(-50, Math.min(50, gameState.kpis.profitability));
            gameState.kpis.roic = Math.max(-50, Math.min(50, gameState.kpis.roic));
            
            // Log final KPI values for debugging
            console.log('Updated KPIs:', gameState.kpis);
        }

        function updateDisplay() {
            // Update year display
            document.getElementById('currentYearDisplay').textContent = `Year ${gameState.currentYear}`;
            document.getElementById('executeYearText').textContent = gameState.currentYear;
            
            // Update KPIs
            document.getElementById('revenue').textContent = `‚Çπ${Math.round(gameState.kpis.revenue)}Cr`;
            document.getElementById('marketShare').textContent = `${gameState.kpis.marketShare.toFixed(1)}%`;
            document.getElementById('profitability').textContent = `${gameState.kpis.profitability.toFixed(1)}%`;
            document.getElementById('satisfaction').textContent = `${Math.round(gameState.kpis.satisfaction)}%`;
            document.getElementById('roic').textContent = `${Math.round(gameState.kpis.roic)}%`;
            
            // Update KPI colors
            updateKPIColors();
            
            updateBudgetDisplay();
            updateCarryoverBudgetDisplay();
        }

        function updateKPIColors() {
            const revenue = document.getElementById('revenue');
            revenue.className = gameState.kpis.revenue >= 3000 ? 'kpi-value positive' : 'kpi-value neutral';
            
            const marketShare = document.getElementById('marketShare');
            if (gameState.kpis.marketShare >= 30) marketShare.className = 'kpi-value positive';
            else if (gameState.kpis.marketShare >= 15) marketShare.className = 'kpi-value warning';
            else marketShare.className = 'kpi-value negative';
            
            const profitability = document.getElementById('profitability');
            profitability.className = gameState.kpis.profitability >= 5 ? 'kpi-value positive' : 
                                    gameState.kpis.profitability >= 0 ? 'kpi-value warning' : 'kpi-value negative';
            
            const satisfaction = document.getElementById('satisfaction');
            satisfaction.className = gameState.kpis.satisfaction >= 90 ? 'kpi-value positive' : 'kpi-value warning';
            
            const roic = document.getElementById('roic');
            roic.className = gameState.kpis.roic >= 10 ? 'kpi-value positive' : 
                            gameState.kpis.roic >= 0 ? 'kpi-value warning' : 'kpi-value negative';
        }

        function showGameResults() {
            // First, mark the game as completed and save the final state.
            // This ensures the admin panel gets the update immediately.
            gameState.gameCompleted = true;
            if (teamId) {
                const teamStateRef = database.ref(`teamStates/team${teamId}`);
                teamStateRef.set(gameState);
            }

            const totalScore = calculateFinalScore();
            const crossedChasm = gameState.kpis.marketShare >= 30;
            const scoringTargets = gameState.kpis.profitability >= 5 && gameState.kpis.roic >= 10;
            
            // NEW: Determine ranking tier based on final score
            let rankingTier = '';
            let rankingColor = '';
            if (totalScore >= 70) {
                rankingTier = 'TOP TIER üèÜ';
                rankingColor = '#27ae60'; // Green
            } else if (totalScore >= 60) {
                rankingTier = 'MID TIER üìà';
                rankingColor = '#f39c12'; // Orange
            } else {
                rankingTier = 'BOTTOM TIER üìâ';
                rankingColor = '#e74c3c'; // Red
            }
            
            let resultsHtml = `
                <div style="text-align: center; padding: 20px;">
                    <h2>${crossedChasm ? 'üéâ Mission Accomplished!' : 'üìä Final Results'}</h2>
                    
                    ${crossedChasm ? 
                        '<div style="background: #d5f4e6; padding: 15px; border-radius: 8px; margin: 20px 0;">üèÜ Congratulations! You successfully crossed the chasm with >30% market share!</div>' :
                        '<div style="background: #fadbd8; padding: 15px; border-radius: 8px; margin: 20px 0;">‚ùå Mission incomplete. You did not achieve >30% market share to cross the chasm.</div>'
                    }
                    
                    ${scoringTargets ? 
                        '<div style="background: #d5f4e6; padding: 15px; border-radius: 8px; margin: 20px 0;">‚≠ê Excellent! You achieved both scoring targets: Profitability >5% and ROIC >10%</div>' :
                        '<div style="background: #fdeaa7; padding: 15px; border-radius: 8px; margin: 20px 0;">‚ö†Ô∏è Scoring targets missed. Need Profitability >5% AND ROIC >10% for top ranking.</div>'
                    }
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0; text-align: left;">
                        <div>
                            <h4>üìä Final KPIs</h4>
                            <div style="margin: 10px 0;">
                                <strong>Market Share:</strong> ${gameState.kpis.marketShare.toFixed(1)}% 
                                <span style="color: ${gameState.kpis.marketShare >= 30 ? '#27ae60' : '#e74c3c'}">(Target: >30% to cross chasm)</span>
                            </div>
                            <div style="margin: 10px 0;">
                                <strong>Profitability:</strong> ${gameState.kpis.profitability.toFixed(1)}% 
                                <span style="color: ${gameState.kpis.profitability >= 5 ? '#27ae60' : '#e74c3c'}">(Scoring Target: 5%+)</span>
                            </div>
                            <div style="margin: 10px 0;">
                                <strong>ROIC:</strong> ${Math.round(gameState.kpis.roic)}% 
                                <span style="color: ${gameState.kpis.roic >= 10 ? '#27ae60' : '#e74c3c'}">(Scoring Target: 10%+)</span>
                            </div>
                            <div style="margin: 10px 0;">
                                <strong>Revenue:</strong> ‚Çπ${Math.round(gameState.kpis.revenue)}Cr 
                                <span style="color: ${gameState.kpis.revenue >= 3000 ? '#27ae60' : '#e74c3c'}">(Target: No hard target, soft target: ‚Çπ2000Cr+)</span>
                            </div>
                            <div style="margin: 10px 0;">
                                <strong>Customer Satisfaction:</strong> ${Math.round(gameState.kpis.satisfaction)}% 
                                <span style="color: ${gameState.kpis.satisfaction >= 90 ? '#27ae60' : '#e74c3c'}">(Target: No hard target, soft target: 90%+)</span>
                            </div>
                        </div>
                        
                        <div>
                            <h4>üéì Key Learning Outcomes</h4>
                            <ul style="margin: 15px 0; padding-left: 20px; font-size: 0.9rem;">
                                <li><strong>Strategic Planning:</strong> Long-term technology investments require careful balance of cost and capability</li>
                                <li><strong>Market Adaptation:</strong> External events can disrupt even the best-laid plans</li>
                                <li><strong>Budget Discipline:</strong> Resource constraints force prioritization decisions</li>
                                <li><strong>Course Correction:</strong> Flexibility comes with costs, consistency has value</li>
                                <li><strong>Technology Integration:</strong> Interdependencies matter in complex systems</li>
                                <li><strong>Budget Management:</strong> Carryover budgets provide strategic flexibility</li>
                                <li><strong>Synergy Optimization:</strong> Aligning decisions with market events creates multiplicative returns</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div style="margin: 30px 0;">
                        <strong>Final Score:</strong> ${Math.round(totalScore)} points<br>
                        <strong>Chasm Status:</strong> ${crossedChasm ? 'CROSSED ‚úÖ' : 'NOT CROSSED ‚ùå'}<br>
                        <strong>Ranking Category:</strong> <span style="color: ${rankingColor}; font-weight: bold;">${rankingTier}</span>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; text-align: left;">
                        <h4>üìà Strategic Recommendations for Next Iteration:</h4>
                        <p style="margin: 10px 0;"><strong>Year 1-2 Focus:</strong> Prioritize Industry 4.0 + Zero-trust + AI Personalization for maximum synergy bonuses</p>
                        <p style="margin: 10px 0;"><strong>Year 3-4 Focus:</strong> Enterprise Data Lakehouse + course correction as needed based on market evolution</p>
                        <p style="margin: 10px 0;"><strong>Budget Strategy:</strong> Balance high-impact investments early with flexibility for market changes</p>
                    </div>
                    
                    <button class="action-btn success" onclick="window.location.href='index.html'">
                        üîÑ Return to Main Page
                    </button>
                </div>
            `;
            
            document.querySelector('.main-panel').innerHTML = resultsHtml;
        }

        function calculateFinalScore() {
            const weights = {
                revenue: 0.15,
                marketShare: 0.30,
                profitability: 0.20,
                satisfaction: 0.15,
                roic: 0.20
            };
            
            const normalizedKPIs = {
                revenue: Math.min(gameState.kpis.revenue / 5000, 1) * 100, // Normalize to 5000Cr max
                marketShare: Math.min(gameState.kpis.marketShare / 50, 1) * 100, // Normalize to 50% max
                profitability: Math.min(Math.max(gameState.kpis.profitability + 20, 0) / 45, 1) * 100, // -20% to 25% range
                satisfaction: gameState.kpis.satisfaction, // Already 0-100
                roic: Math.min(Math.max(gameState.kpis.roic + 20, 0) / 90, 1) * 100 // -20% to 50% range
            };
            
            const finalScore = Object.entries(normalizedKPIs).reduce((total, [kpi, value]) => {
                return total + (value * weights[kpi]);
            }, 0);

            return finalScore;
        }

        function showMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;
            
            // Insert at top of current tab
            const activeTab = document.querySelector('.tab-content.active');
            activeTab.insertBefore(messageDiv, activeTab.firstChild);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        function startTimer(startTime, duration) {
            clearInterval(gameTimerInterval);
            const timerDisplay = document.getElementById('gameTimerDisplay');

            gameTimerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const remaining = duration - elapsed;

                if (remaining <= 0) {
                    clearInterval(gameTimerInterval);
                    timerDisplay.textContent = "00:00";
                    if (!gameState.gameCompleted) {
                        showGameResults();
                        showMessage('Time is up! The game has ended.', 'error');
                    }
                    return;
                }

                const minutes = Math.floor((remaining / 1000) / 60);
                const seconds = Math.floor((remaining / 1000) % 60);
                timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        // Initialize the game
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            teamId = urlParams.get('team');
            const startGameBtn = document.getElementById('startGameBtn');
            const waitMessage = document.getElementById('waitMessage');
            const teamNames = [
                "Team RAM- Rapid Action Minds",
                "Team GB-Giggle Bytes",
                "Team WiFi- We're fun inside",
                "Team AI- Accelerated Innovators",
                "Team IP- Infinite Pings",
                "Team WAF- We are Fabulous",
                "Team TAG- Think, Act, Grow",
                "Team SSO- Smart Solutions only",
                "Team TB- Tech Brigade",
                "Team MB- Mega Buddies"
            ];

            if (!teamId || teamId < 1 || teamId > 10) {
                document.body.innerHTML = '<h1>Error: Invalid team selected. Please go back to the main page.</h1>';
                return;
            }

            const teamName = teamNames[teamId - 1];
            teamScoreRef = database.ref(`scores/team${teamId}`);
            document.querySelector('.team-info span').textContent = `Voltara Motors CDIO Dashboard - ${teamName}`;
            
            startGameBtn.disabled = true; // Disable by default

            const teamStateRef = database.ref(`teamStates/team${teamId}`);
            teamStateRef.once('value').then((snapshot) => {
                const savedState = snapshot.val();
                if (savedState) {
                    // A saved state exists, load it.
                    gameState = savedState;
                    console.log("Loaded saved game state for Team " + teamId, gameState);
                    
                    // If the game is already completed, show results immediately.
                    if (gameState.gameCompleted) {
                        showGameResults();
                        return; // Stop further initialization
                    }
                    
                    // Restore the UI to the correct state
                    resetForNextYear(); 
                } else {
                    console.log("No saved state for Team " + teamId + ". Starting a new game.");
                    // Initial UI setup for a new game
                    updateDisplay();
                    updateInvestmentSummary();
                    updateCarryoverBudgetDisplay();
                }

                // Attach the listener for admin controls AFTER loading the initial state
                gameStateRef.on('value', (stateSnapshot) => {
                    const state = stateSnapshot.val();
                    if (state && state.isStarted) {
                        startGameBtn.disabled = false;
                        waitMessage.style.display = 'none';
                        startTimer(state.startTime, state.duration);
                    } else {
                        startGameBtn.disabled = true;
                        waitMessage.style.display = 'block';
                        waitMessage.textContent = 'Please wait for the administrator to start the game.';
                        waitMessage.style.color = '#c0392b';
                        
                        if (document.body.classList.contains('game-started')) {
                            document.getElementById('gameInterface').style.display = 'none';
                            document.getElementById('gameSelection').style.display = 'block';
                            document.body.classList.remove('game-started');
                        }

                        clearInterval(gameTimerInterval);
                        document.getElementById('gameTimerDisplay').textContent = "20:00";
                    }
                });
            });

            startGameBtn.addEventListener('click', startGame);
        });
    </script>
</body>
</html>
